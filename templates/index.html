<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Farming Help - Smart Crop Health Assistant</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css">

    <style>
        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #1b4332, #2d6a4f, #40916c);
            color: #f1f5f9;
        }
        .glass-card {
            background: rgba(15, 23, 42, 0.82);
            border-radius: 22px;
            box-shadow: 0 18px 45px rgba(0, 0, 0, 0.45);
            border: 1px solid rgba(148, 163, 184, 0.35);
        }
        .soft-card {
            background: rgba(15, 23, 42, 0.92);
            border-radius: 18px;
            border: 1px solid rgba(148, 163, 184, 0.3);
        }
        .btn-main {
            border-radius: 999px;
            font-weight: 600;
            letter-spacing: 0.04em;
        }
        .badge-risk {
            font-size: 0.9rem;
        }
        .section-title {
            font-weight: 700;
            letter-spacing: 0.05em;
            text-transform: uppercase;
            font-size: 0.9rem;
            color: #a3e635;
        }
        a { color: #38bdf8; }
        a:hover { color: #e0f2fe; }
        .recommendation-text p {
            margin-bottom: 0.25rem;
            white-space: pre-wrap;
        }

        /* Chat UI */
        #chatBox {
            height: 290px;
            overflow-y: auto;
            background: rgba(2, 6, 23, 0.35);
            border-radius: 14px;
            border: 1px solid rgba(148, 163, 184, 0.3);
            padding: 14px;
        }
        .chat-msg { margin-bottom: 10px; line-height: 1.25rem; }
        .chat-you strong { color: #60a5fa; }
        .chat-bot strong { color: #a3e635; }
        .chat-meta {
            font-size: 0.8rem;
            color: rgba(241, 245, 249, 0.65);
            margin-top: 6px;
        }

        /* NDVI prototype */
        .note-text { color: rgba(241, 245, 249, 0.75); font-size: 0.9rem; }
        .code-pill {
            font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
            font-size: 0.85rem;
            padding: 2px 8px;
            border-radius: 999px;
            background: rgba(148, 163, 184, 0.15);
            border: 1px solid rgba(148, 163, 184, 0.25);
            display: inline-block;
        }
    </style>
</head>

<body>

<div class="container py-4">

    <!-- Header -->
    <div class="glass-card p-4 mb-4">
        <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
            <div>
                <h2 class="fw-bold mb-1">üåæ Farming Help</h2>
                <p class="mb-0 text-secondary">
                    Smart plant disease detection with weather-aware risk, severity, and curated recommendations.
                </p>
            </div>

            <div class="text-md-end">
                <div class="small text-secondary">
                    Logged in as <strong class="text-light">{{ session.username }}</strong>
                </div>
                <a href="/logout" class="btn btn-outline-light btn-sm btn-main mt-2">Logout</a>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Left: Upload + NDVI + Grad-CAM -->
        <div class="col-lg-5">
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Step 1</p>
                <h4 class="fw-bold mb-3">Upload Leaf Image</h4>

                <form method="POST" enctype="multipart/form-data">
                    <input type="hidden" name="action" value="analyze">

                    <div class="mb-3">
                        <label class="form-label fw-semibold">Leaf Image</label>
                        <input type="file" name="file" class="form-control" required>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">City (for Weather)</label>
                        <input type="text" name="city" class="form-control" value="{{ city }}" placeholder="e.g., Jaipur">
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">State (for Laws + Soil Defaults)</label>
                        <input type="text" name="state" class="form-control" value="{{ state }}" placeholder="e.g., Rajasthan">
                        {% if soil_defaults %}
                        <div class="form-text text-light">
                            Common soils for <strong>{{ state }}</strong>: {{ soil_defaults | join(", ") }}
                        </div>
                        {% endif %}
                    </div>

                    <!-- ‚úÖ Soil add-on -->
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Soil Type (optional)</label>
                        <select name="soil_type" class="form-select">
                            <option value="">Auto (use state default)</option>
                            {% for s in soil_types %}
                                <option value="{{ s }}" {% if soil_type==s %}selected{% endif %}>{{ s }}</option>
                            {% endfor %}
                        </select>

                        {% if chosen_soil %}
                        <div class="form-text text-light">
                            Selected soil: <strong>{{ chosen_soil }}</strong>
                            {% if soil_source %} ({{ soil_source }}){% endif %}
                        </div>
                        {% endif %}

                        {% if soil_info and soil_info.traits %}
                        <div class="form-text text-light">
                            Traits:
                            <span class="badge bg-secondary">Water: {{ soil_info.traits.water_retention }}</span>
                            <span class="badge bg-secondary">Drainage: {{ soil_info.traits.drainage }}</span>
                            <span class="badge bg-secondary">pH: {{ soil_info.traits.ph_tendency }}</span>
                        </div>
                        {% endif %}
                    </div>

                    <button class="btn btn-success btn-main w-100 mt-2">Analyze Image</button>
                </form>
            </div>

            <!-- NDVI (Prototype) -->
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Phase 2</p>
                <h4 class="fw-bold mb-2">NDVI Crop Health (Prototype)</h4>

                <div class="alert alert-warning mb-3">
                    <strong>Status:</strong> NDVI-like vegetation index module is under integration.
                    <div class="mt-2 note-text">
                        Backend endpoint already exists: <span class="code-pill">POST /ndvi/analyze</span>
                    </div>
                </div>

                <div class="note-text mb-2">
                    Planned outputs:
                    <ul class="mb-2">
                        <li>NDVI mean</li>
                        <li>Stress percentage</li>
                        <li>Health category (Healthy / Moderate / Stressed)</li>
                    </ul>
                </div>

                <button class="btn btn-secondary btn-main w-100" disabled>
                    NDVI Analysis (UI coming soon)
                </button>
            </div>

            <!-- Uploaded Image -->
            {% if image %}
            <div class="soft-card p-3 mb-4">
                <p class="section-title mb-1">Preview</p>
                <h5 class="fw-bold mb-2">Uploaded Leaf</h5>
                <img src="/{{ image }}" class="img-fluid rounded border border-secondary" style="max-height: 320px; object-fit: contain;">
            </div>

            <!-- Grad-CAM Button -->
            <div class="soft-card p-3 mb-4">
                <p class="section-title mb-1">Step 2</p>
                <h5 class="fw-bold mb-3">Explain Prediction (Grad-CAM)</h5>
                <form method="POST">
                    <input type="hidden" name="action" value="gradcam">
                    <input type="hidden" name="image_path" value="{{ image_path_internal }}">
                    <input type="hidden" name="city" value="{{ city }}">
                    <input type="hidden" name="state" value="{{ state }}">
                    <input type="hidden" name="soil_type" value="{{ soil_type }}">
                    <button class="btn btn-warning btn-main w-100">Generate Grad-CAM üî•</button>
                </form>
            </div>
            {% endif %}

            <!-- Grad-CAM Result -->
            {% if gradcam %}
            <div class="soft-card p-3 mb-4">
                <p class="section-title mb-1">Explainability</p>
                <h5 class="fw-bold mb-2">Grad-CAM Heatmap</h5>
                <img src="/{{ gradcam }}" class="img-fluid rounded border border-secondary">
            </div>
            {% endif %}
        </div>

        <!-- Right: Chatbot + Results, Severity, Recs, Market, Laws, Weather -->
        <div class="col-lg-7">

            <!-- Chatbot -->
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Assistant</p>
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-2">
                    <h5 class="fw-bold mb-0">Chatbot </h5>
                    <button class="btn btn-outline-light btn-sm" type="button" onclick="resetChat()">Reset</button>
                </div>

                <div class="chat-meta mt-2">
                    Uses current analysis context (label, severity, weather, soil, laws, marketplace).
                </div>

                <div id="chatBox" class="mt-3">
                    <div class="chat-msg chat-bot">
                        <strong>Bot:</strong> Hi! Ask: ‚ÄúWhat should I do now?‚Äù, ‚ÄúExplain the risk‚Äù, ‚ÄúGive precautions‚Äù.
                    </div>
                </div>

                <div class="input-group mt-3">
                    <input id="chatInput" type="text" class="form-control" placeholder="Type your question...">
                    <button class="btn btn-info text-dark fw-semibold" type="button" onclick="sendChat()">Send</button>
                </div>

                <div class="chat-meta">
                    Tip: After <strong>Analyze Image</strong>, ask: ‚ÄúSummarize my case in 5 steps‚Äù.
                </div>
            </div>

            <!-- Prediction + Risk (with Severity under label) -->
            {% if result %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Result</p>
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3">
                    <div>
                        <h5 class="fw-bold mb-1">Predicted Label</h5>
                        <p class="fs-5 mb-1 text-info">{{ result }}</p>

                        {% if severity %}
                        <p class="mb-0">
                            <strong>Severity (Weather-based view):</strong> {{ severity }}
                        </p>
                        {% endif %}

                        {% if chosen_soil %}
                        <p class="mb-0 mt-2">
                            <strong>Soil Context:</strong> {{ chosen_soil }}
                            {% if soil_source %} ({{ soil_source }}){% endif %}
                        </p>
                        {% endif %}
                    </div>

                    <div class="text-md-end">
                        {% if risk %}
                        <h6 class="fw-semibold mb-1">Disease Risk (Weather)</h6>
                        {% if risk == "Low" %}
                            <span class="badge bg-success badge-risk px-3 py-2">Low</span>
                        {% elif risk == "Moderate" %}
                            <span class="badge bg-warning text-dark badge-risk px-3 py-2">Moderate</span>
                        {% elif risk == "High" %}
                            <span class="badge bg-danger badge-risk px-3 py-2">High</span>
                        {% elif risk == "Severe" %}
                            <span class="badge bg-dark badge-risk px-3 py-2">Severe</span>
                        {% else %}
                            <span class="badge bg-secondary badge-risk px-3 py-2">Unknown</span>
                        {% endif %}
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Separate Severity Card -->
            {% if severity %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Disease Severity</p>
                <h5 class="fw-bold mb-2">{{ severity }}</h5>
                {% if weather %}
                <p class="mb-0 text-secondary small">
                    Estimated using humidity {{ weather.humidity }}% and temperature {{ weather.temp_c }}¬∞C.
                </p>
                {% else %}
                <p class="mb-0 text-secondary small">
                    Estimated from default thresholds (no live weather data provided).
                </p>
                {% endif %}
            </div>
            {% endif %}

            <!-- Recommendations -->
            {% if recommendations %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Advisory</p>
                <h5 class="fw-bold mb-3">Recommendations</h5>

                {% if severity %}
                <p><strong>Overall Severity:</strong> {{ severity }}</p>
                {% endif %}

                <div class="recommendation-text">
                    {% for line in recommendations %}
                    <p>{{ line }}</p>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Marketplace -->
            {% if market %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Inputs</p>
                <h5 class="fw-bold mb-3">Recommended Products</h5>
                <div class="row g-3">
                    {% for p in market %}
                    <div class="col-md-6">
                        <div class="border border-secondary rounded-3 p-2 h-100">
                            <strong>{{ p.name }}</strong><br>
                            <small class="text-muted">{{ p.pack }} ‚Äî ‚Çπ{{ p.price_inr }}</small><br>
                            <a href="{{ p.buy_url }}" target="_blank">View / Buy</a>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Laws -->
            {% if laws_links %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Compliance</p>
                <h5 class="fw-bold mb-3">Government Laws & Guidelines</h5>
                <ul class="mb-0">
                    {% for l in laws_links %}
                    <li>
                        <a href="{{ l.link }}" target="_blank">{{ l.title }}</a>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            {% endif %}

            <!-- Weather -->
            {% if weather or forecast or weather_error %}
            <div class="soft-card p-4 mb-4">
                <p class="section-title mb-1">Weather</p>

                {% if weather %}
                <div class="d-flex align-items-center justify-content-between mb-3">
                    <div>
                        <h5 class="fw-bold mb-1">{{ weather.city }}</h5>
                        <p class="mb-0">
                            {{ weather.temp_c }}¬∞C ‚Ä¢ {{ weather.humidity }}% humidity ‚Ä¢ {{ weather.description }}
                        </p>
                    </div>
                    <div>
                        <img src="{{ weather.icon }}" alt="icon">
                    </div>
                </div>
                {% endif %}

                {% if weather_error %}
                <p class="text-danger mb-2">{{ weather_error }}</p>
                {% endif %}

                {% if forecast %}
                <h6 class="fw-semibold mt-3 mb-2">Next 12 Hours</h6>
                <ul class="mb-0">
                    {% for f in forecast %}
                    <li class="mb-1">
                        {{ f.time }} ‚Äî {{ f.temp_c }}¬∞C, {{ f.humidity }}% ‚Ä¢ {{ f.desc }}
                        <img src="{{ f.icon }}" width="32">
                    </li>
                    {% endfor %}
                </ul>
                {% endif %}

                {% if forecast_error %}
                <p class="text-danger mb-0">{{ forecast_error }}</p>
                {% endif %}
            </div>
            {% endif %}

        </div>
    </div>
</div>

<script>
    // Context from current page (safe JSON via Jinja)
    const chatContext = {
        result: {{ result|tojson if result else "null" }},
        severity: {{ severity|tojson if severity else "null" }},
        risk: {{ risk|tojson if risk else "null" }},
        weather: {{ weather|tojson if weather else "null" }},
        chosen_soil: {{ chosen_soil|tojson if chosen_soil else "null" }},
        soil_info: {{ soil_info|tojson if soil_info else "null" }},
        market: {{ market|tojson if market else "null" }},
        laws_links: {{ laws_links|tojson if laws_links else "null" }}
    };

    function appendMessage(sender, text, mode) {
        const box = document.getElementById("chatBox");
        const div = document.createElement("div");

        const cls = sender === "You" ? "chat-you" : "chat-bot";
        div.className = "chat-msg " + cls;

        const safeText = (text || "").toString().replace(/\n/g, "<br>");
        const modeTag = mode ? ` <span class="badge bg-secondary ms-2">${mode}</span>` : "";

        div.innerHTML = `<strong>${sender}:</strong> ${safeText}${sender === "Bot" ? modeTag : ""}`;
        box.appendChild(div);
        box.scrollTop = box.scrollHeight;
    }

    async function sendChat() {
        const input = document.getElementById("chatInput");
        const message = input.value.trim();
        if (!message) return;

        appendMessage("You", message);
        input.value = "";

        appendMessage("Bot", "Typing...", "‚Ä¶");
        const box = document.getElementById("chatBox");
        const last = box.lastChild;

        try {
            const res = await fetch("/chat", {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({ message, ...chatContext })
            });

            const data = await res.json();
            if (last) last.remove();
            appendMessage("Bot", data.reply || "No response.", data.mode || "");
        } catch (e) {
            if (last) last.remove();
            appendMessage("Bot", "Chatbot service not available right now.", "fallback");
        }
    }

    async function resetChat() {
        try {
            await fetch("/chat/reset", { method: "POST" });
            const box = document.getElementById("chatBox");
            box.innerHTML = `
                <div class="chat-msg chat-bot">
                    <strong>Bot:</strong> Chat cleared ‚úÖ Ask me about disease, severity, weather risk, soil, laws, or products.
                </div>`;
        } catch (e) {}
    }

    document.getElementById("chatInput").addEventListener("keydown", function (e) {
        if (e.key === "Enter") sendChat();
    });
</script>

</body>
</html>
